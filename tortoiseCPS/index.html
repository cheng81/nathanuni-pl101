<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="../css/codemirror.css"/>
<link rel="stylesheet" href="../css/monokai.css"/>
<link rel="stylesheet" href="../css/bootstrap.min.css"/>
<style type="text/css">
body {margin-top: 70px;}
#desk {border: solid 2px #CCC;}
#examples {display: none;}
</style>
<script type="text/javascript" src="../js/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="../js/bootstrap.min.js"></script>
<script type="text/javascript" src="../js/codemirror.js"></script>
<script type="text/javascript" src="../js/raphael-min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
var srcArea = $('textarea#source')[0];
var myCodeMirror = CodeMirror.fromTextArea(srcArea,{
	lineNumbers: true,
	theme: 'monokai'
});
var toload = window.location.protocol==='file:' ?
  "../../nathanuni-pl101/lesson8/dist/tortoise.js" :
  "https://rawgit.com/cheng81/nathanuni-pl101/master/lesson8/dist/tortoise.js";
var head = document.getElementsByTagName('head')[0];
var script = document.createElement('script');
script.type = "text/javascript";

var require = null;
var tortoise = null;
var raphael = null;
console.log('toload',toload);
script.onload = function() {
  console.log('tortoise loaded');
  require = window.node2browser.require;
  tortoise = require('tortoise'); 
  var desk = $('#desk');
  var w = $(desk).width();
  console.log('width',$(desk).width());
  // turtle = new tortoise.turtlelib.Turtle(desk[0],w,w);
  raphael = Raphael(desk[0],w,w);
  console.log('raphael',raphael);
  tortoise.bootstrap(raphael,w,w);
}
script.src = toload;
head.appendChild(script);

var booted = false;
var intv;
$('a#make').click(function(e) {
  e.preventDefault();

  if(booted === false) {
    var text = myCodeMirror.getValue();
    console.log('eval',text);
    tortoise.start(text);
    booted = true;
  }
  var res;
  intv = window.setInterval(
    function() {
      res = tortoise.step();
      if(res !== undefined) {
        window.clearInterval(intv);
        console.log(res);
      }
    }
    ,1);

  return false;
});

$('a#step').click(function(e) {
  e.preventDefault();
  if(booted === false) {
    var text = myCodeMirror.getValue();
    console.log('eval',text);
    tortoise.start(text);
    booted = true;
  } else {
    var res = tortoise.step();
    if(res!==undefined) {
      console.log(res);
      booted = false;
    }
  }
});

$('a#pause').click(function(e) {
  e.preventDefault();
  console.log('pause');
  window.clearInterval(intv);
  return false;
})
$('a#clear').click(function(e) {
  e.preventDefault();
  console.log('clearing');
  raphael.clear();
  booted=false;
  return false;
});

var doc=false;
$('a#toggleDoc').click(function(e) {
  e.preventDefault();
  if(doc===false) {
    $('#doc').show();
    $('a#toggleDoc').text('Hide Doc');
  } else {
    $('#doc').hide();
    $('a#toggleDoc').text('Show Doc');
  }
  doc=!doc;
  return false;
});

var btns = $('div#examples-btn');
$('div#examples > div').each(function(idx,div) {
  var theid = div.id;
  $(btns).append('<a class="btn btn-info btn-small" id="load-'+theid+'">'+theid+'</a>');
//  $(btns).append('<input type="button" id="load-'+theid+'" value="'+theid+'"/>');
  $('a#load-'+theid).click(function(e) {
    e.preventDefault();
    myCodeMirror.setValue($(div).text());
    return false;
  });
});

});

</script>
</head>
<body>
<div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="http://cheng81.github.com/nathanuni-pl101/tortoiseCPS/index.html">Tortoise</a>
          <div class="nav-collapse">
            <ul class="nav">
              <!--<li class="active"><a href="">Interpreter</a></li>-->
              <li><a href="http://www.nathansuniversity.com">Nathan's University</a></li>
              <li><a href="http://www.github.com/cheng81/nathanuni-pl101/">GitHub</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

<div class="container">
	<div class="page-header"><h1>Tortoise interpreter</h1> by fzan
      <div class="btn-group" id="examples-btn" style="margin-top: 1em">
      </div>
    </div>
	<div class="hero-unit">
    <a id="toggleDoc" style="margin-bottom: 1em;" class="btn btn-primary btn-large">Show Doc</a>

<div id="doc" style="display:none;">
      <h2>Data Types</h2>
      <p>Tortoise accepts numbers (positive and negative, integers and floats) and booleans.</p>
      <h2>Language constructs</h2>
      <dl>
        <dt>Variables</dt>
        <dd>
          <ul class="unstyled">
            <li><code>var name;</code>, declares a variable</li>
            <li><code>name := expr</code>, assigns expr to variable name</li>
            <li><code>var name := expr</code>, declares and assign expr to variable name</li>
          </ul>
        </dd>
        <dt>Functions and threads</dt>
        <dd>
          <ul class="unstyled">
            <li><code>define name( args ) { body }</code>, defines a variable</li>
            <li><code>name(args);</code>, call the function. Functions can be curried, as in:
              <pre>
define foo (a,b) {
  a + b;
}
var add5 := foo(5);
add5(10);
//result 15
              </pre></li>
            <li><code>spawn name( args );</code>, creates a new "thread" and start it</li>
          </ul>
        </dd>
        <dt>Control Flow</dt>
        <dd>
          <ul class="unstyled">
            <li><code>if ( test ) { body } else { body }</code>, optional else</li>
            <li><code>repeat ( expr ) { body }</code></li>
            <li><code>throw expr;</code>, throws an exception</li>
            <li><code>yield;</code>, returns the control flow to some other ready thread</li>
          </ul>
        </dd>
        <dt>Locks</dt>
        <dd>
          <code>lock ( name ) { body }</code>, 
          tries to acquire the name lock. If the lock is already used, the thread is put to wait.
          When (well, if) the body is (ever) executed, the lock is automatically released afterward.
        </dd>
        <dt>Exceptions</dt>
        <dd>
          <code>try { body } catch name { body }</code>, tries to execute the first body. If an exception occurs,
          the catch body is executed. The exceptional value is assigned to the name variable
        </dd>
        <dt>Controlling the turtle(s)<dt>
        <dd>
          <ul class="unstyled">
            <li><code>with ( expr ) { body }</code>,
              the turtle resolved in the expression is used in the body.
              The turtle bindings are treated as in dynamic scope, so you can call a drawing function
              in the body without explicitly passing the turtle around</li>
            <li><code>make()</code>, creates a fresh turtle</li>
            <li><code>clone( expr )</code>, clone the turtle resolved in the expression</li>
            <li><code>clear()</code>, reset the turtle</li>
            <li><code>push()</code>, push a new state in the turtle (the top state is cloned)</li>
            <li><code>pop()</code>, pop a state from the turtle</li>
            <li><code>forward( num )</code></li>
            <li><code>left( num )</code></li>
            <li><code>right( num )</code></li>
            <li><code>penUp()</code>, do not draw the following commands</li>
            <li><code>penDown()</code>, draw the following commands</li>
            <li><code>home()</code>, go back to the center of the canvas. Do not modifies the angle</li>
            <li><code>opacity( num )</code>, sets the stroke opacity</li>
            <li><code>colorRGB( num,num,num )</code>, sets the current color</li>
            <li><code>stroke( num )</code>, sets the current stroke width</li>
            <li><code>scale( num )</code>, scale the following commands (num is multiplied with current scale value)</li>
            <li><code>strokeScale( num )</code>, scale the stroke width (num is multiplied with current stroke scale value)</li>

          </ul>
        </dd>
      </dl>
    </div>

		<textarea id="source">/*tortoise code*/
</textarea>
      <div class="btn-group">
        <a id="make" class="btn btn-primary btn-large">Play <i class="icon-play icon-white"></i></a>
        <a id="pause" class="btn btn-primary btn-large">Pause <i class="icon-pause icon-white"></i></a>
        <a id="step" class="btn btn-primary btn-large">Step</a>
        <a id="clear" class="btn btn-primary btn-large">Clear</a>
      </div>
    <div class="clearfix">&nbsp;</div>
    <p id="desk">&nbsp;</p>
    
	</div>

</div>

<div id="examples">
  <div id="Fractal-tree">// Fractal-tree, McLeopold sample
// http://nathansuniversity.com/vanilla/discussion/comment/1495#Comment_1495
define curve(size, angle, scale, count) {
 if (count > 0) {
  stroke((size * scale) / 10);
  forward(size);
  left(angle);
  curve(size * scale, angle, scale, count - 1);
 
  right(90);
  curve(size * scale * scale, angle, scale, count - 1);
  left(90);
 
  right(angle);
  right(180);
  forward(size);
  left(180);
 
 }
}

define tree(angle) {
  with(make()) {
    right(angle);
    curve(100, 29, 0.80, 8);  
  }   
}

spawn tree(0);
spawn tree(90);
spawn tree(180);
spawn tree(270);</div>
  <div id="Sierpinski-triangle">// Sierpinski triangle (http://en.wikipedia.org/wiki/Sierpinski_triangle)
// Adapted from http://oather.github.com/nu/pl101/l06-1/index.html

define unitTri() {
  forward(1);
  left(120);
  forward(1);
  left(120);
  forward(1);
}

define move(x,y) {
  penUp();
  right(90);
  forward(x);
  left(90);
  forward(y);
  penDown();
}
define tri(n) {
  push();
  n := n - 1;
  if (n == 0) { unitTri(); }
  if (n > 0) {
    scale(1/2);
    tri(n);
    move(0, 1);
    tri(n);
    left(120);
    move(0, 1);
    right(120);
    tri(n);
  }
  pop();
}

define iteration(num) {
  push();
  right(90);
    stroke((numIter+1)-num);
  scale(500);
  move(0.5, -0.5);
  tri(num);
    pop();
    home();
    if(num > 1) {
      iteration(num-1);
    }
}

var numIter := 5;
with(make()) {
  iteration(numIter);  
}
</div>
</div>

</body>
</html>